# Версия 4.x

## [4.6]

### Added
- **Система опциональных зависимостей** — новый механизм для объявления необязательных зависимостей в `config.yaml`
- **Разделение зависимостей** — четкое разделение на `dependencies` (обязательные) и `optional_dependencies` (опциональные)
- **Гибкая архитектура BASE/PRO** — возможность запуска BASE версий без PRO компонентов
- **Упрощенная структура конфигурации** — убран лишний уровень вложенности в секции `dependencies`, теперь зависимости указываются напрямую как список строк

### Changed
- **Логика версионирования** — изменена по умолчанию: все плагины считаются PRO, только явно помеченные — BASE
- **Обработка зависимостей в DI-контейнере** — корректная передача всех доступных зависимостей (обязательных + опциональных)
- **Порядок инициализации** — учет всех зависимостей при построении плана запуска для корректной последовательности

### Fixed
- **Исправлены архитектурные нарушения** — BASE плагины больше не зависят от PRO плагинов как обязательных зависимостей
- **Обработка отсутствующих опциональных зависимостей** — корректная работа с `kwargs.get()` вместо `kwargs['key']`
- **Fallback логика** — безопасная обработка отсутствующих опциональных компонентов (возврат пустых строк/None)

### Technical Details
- **Модифицированные плагины**: `tg_api_utils`, `event_parser`, `tg_mtproto_parser`, `file_downloader`, `tg_messenger`, `database_service`, `trigger_manager`, `tg_event_bot`, `tg_event_history`, `tg_event_mtproto`
- **Новые методы в PluginsManager**: `get_plugin_mandatory_dependencies()`, `get_plugin_optional_dependencies()`
- **Обновленная логика SettingsManager**: интегрированная проверка доступности зависимостей в едином проходе
- **Изменения в структуре config.yaml**: 
  - Старый формат: `dependencies: { utilities: ["logger", "database"] }`
  - Новый формат: `dependencies: ["logger", "database"]`
  - Добавлена секция `optional_dependencies: ["tg_mtproto"]` для опциональных зависимостей

## [4.5]

### Added
- **TaskManager — новая core утилита** — система управления фоновыми задачами с очередями и приоритетами
- **Пять приоритетных очередей** — critical, high, medium, low, heavy с индивидуальными лимитами
- **Глобальные и локальные лимиты** — контроль параллельности через семафоры
- **Универсальный анализатор сервера** — инструмент `server_analyzer.py` для оптимизации TaskManager
- **Метод `get_utility_on_demand()`** — извлечение утилит из DI-контейнера по требованию
- **Интеграция TaskManager с tg_event_mtproto** — замена ручных фоновых задач на управляемые через TaskManager

### Changed
- **Оптимизированы рекомендации** — лимиты увеличены в 3-12 раз для достижения реальных пределов
- **Обновлена архитектура тестирования** — переход от симуляций к реальному тестированию
- **Улучшено управление MTProto событиями** — переход от `asyncio.create_task()` к контролируемым задачам через TaskManager

### Fixed
- **Исправлена архитектура задач** — корректная передача функций вместо корутин
- **Оптимизированы лимиты по умолчанию** — настройки адаптированы под базовые системы

### Technical
- **Модульная архитектура** — TaskManager, QueueManager, TaskExecutor, ResourceMonitor
- **Система семафоров** — контроль параллельности через asyncio.Semaphore
- **Типизированная система** — TaskItem, QueueConfig, ResourceLimits
- **Первый реальный кейс использования** — tg_event_mtproto использует TaskManager для отложенных событий

## [4.4]

### Added
- **Универсальный MTProto Manager** — создан единый скрипт `mtproto_manager.py` с двухуровневым меню для всех операций с MTProto
- **MTProto Session Analyzer** — специализированная утилита `mtproto_session_analyzer.py` для анализа кэша сессий и поиска entities
- **Двухуровневое меню** — логичное разделение функций: "Работа с сессией" и "Действия с чатами"
- **Полная интеграция функций** — объединены возможности управления сессиями и работы с чатами в одном интерфейсе

### Changed
- **Унифицированы MTProto утилиты** — заменены отдельные скрипты `mtproto_session.py` и `mtproto_service.py` на единый `mtproto_manager.py`
- **Улучшена навигация** — корректная логика выхода из подменю с возвратом в главное меню
- **Расширена функциональность** — добавлена диагностика сессий, информация о файлах, создание новых сессий
- **Оптимизирована архитектура** — четкое разделение между управлением сессиями и работой с чатами

### Fixed
- **Исправлена инициализация DI-контейнера** — корректная инициализация `settings_manager` в утилитах MTProto
- **Улучшена обработка ошибок** — явная обработка исключений вместо проброса в `database_manager.py`
- **Исправлены импорты** — добавлен недостающий импорт `datetime` в утилитах

### Technical
- **Консолидированы утилиты** — создан единый подход к работе с MTProto через `mtproto_manager.py`
- **Специализированный анализ** — отдельная утилита `mtproto_session_analyzer.py` для работы с кэшем сессий
- **Улучшена архитектура** — четкое разделение между управлением сессиями и анализом кэша
- **Оптимизирована навигация** — двухуровневое меню с корректной логикой возврата

## [4.3]

### Added
- **Подготовка к Docker развертыванию** — создан план подготовки проекта к контейнеризации с автоматическим развертыванием

### Changed
- **Исправлен deploy_manager** — адаптирован под новую структуру changelog файлов (поддержка множественных файлов версий)
- **Оптимизировано логирование deploy_manager** — отключено файловое логирование, оставлено только консольное для удобства разработки

### Fixed
- **Исправлен парсинг версий** — deploy_manager теперь корректно определяет версии из новой структуры changelog файлов (docs/changelog/v*.md)
- **Улучшена работа с changelog** — добавлена поддержка сортировки версий и поиска в файлах Unreleased.md и v*.md

## [4.2]

### Added
- **Интеграция GigaChat API** — добавлен новый сервис `gigachat_service` для работы с GigaChat API (чат-модели, генерация текста)
- **Поддержка MarkdownV2** — добавлена библиотека `telegramify-markdown` для корректного отображения ответов GigaChat в Telegram
- **Тестирование GigaChat через Telegram бот** — добавлены сценарии для тестирования функциональности GigaChat через интерфейс бота
- **SSL сертификаты для российских сервисов** — добавлена поддержка SSL сертификатов НУЦ Минцифры для работы с GigaChat API
- **Двухформатный вывод** — сервис возвращает как исходный Markdown (`response_text`), так и экранированный MarkdownV2 (`response_text_md2`) для Telegram

### Changed
- **Обновлена архитектурная документация** — добавлена библиотека `telegramify-markdown` в список используемых библиотек
- **Оптимизированы логи** — убраны отладочные логи из продакшн-кода, оставлены только предупреждения об ошибках

### Fixed
- **Исправлена конвертация Markdown** — заменено использование `telegramify()` на `markdownify()` для корректной работы с библиотекой `telegramify-markdown`
- **Устранена проблема с объектами Text** — исправлена сериализация результатов конвертации Markdown для сохранения в базу данных

## [4.1]

### Added
- **Унификация конфигурации утилит** — все утилиты теперь используют единый стандарт получения настроек через `settings_manager` с автоматическим разрешением переменных окружения
- **Автоматическая загрузка переменных окружения** — `settings_manager` теперь автоматически загружает переменные окружения из `.env` файла при инициализации
- **Расширенная поддержка пресетов устройств** — добавлен новый пресет `test_preset` для тестирования MTProto конфигурации
- **Подробная документация конфигураций** — добавлены детальные описания настроек с примерами использования для `tg_command_registry`, `tg_event_mtproto` и `permission_manager`
- **Система пресетов конфигурации** — создана структура `config/presets/` с поддержкой `default` и `test` пресетов
- **Новые методы `settings_manager`** — добавлен `get_current_preset()` для работы с пресетами
- **Обновлен `env.example`** — добавлена обязательная настройка `CONFIG_PRESET`, компактная структура
- **Тестовые переменные окружения** — добавлены переменные с префиксом `TEST_` для test пресета

### Changed
- **Миграция MTProto конфигурации** — настройки MTProto перенесены из отдельного файла `mtproto.yaml` в глобальные настройки `settings.yaml` под секцией `tg_mtproto`
- **Рефакторинг `tg_bot_initializer`** — утилита теперь получает токен бота через `settings_manager` вместо прямого обращения к переменным окружения
- **Упрощение `auth_manager`** — убрана ручная обработка переменных окружения, теперь используется автоматическое разрешение через `settings_manager`
- **Оптимизация `mtproto_manager`** — убрано дублирование загрузки переменных окружения, теперь используется централизованная загрузка
- **Миграция настроек команд** — настройки регистрации команд перенесены из `bot.yaml` в `settings.yaml` под секцией `tg_command_registry`
- **Миграция настроек ролей** — настройки ролей и прав доступа перенесены из `bot.yaml` в `settings.yaml` под секцией `permission_manager`
- **Упрощение `settings_manager`** — убрана загрузка `bot.yaml`, теперь загружается только `settings.yaml`
- **Поддержка пресетов конфигурации** — добавлена система пресетов для быстрого переключения между средами (dev, test, prod)
- **Обновлена логика загрузки** — добавлен fallback на `default` пресет
- **Упрощение `settings_manager`** — убрана обратная совместимость со старой структурой конфигурации
- **Оптимизация `settings_manager`** — удален неиспользуемый метод `get_preset_path()`
- **Обновлен test пресет** — добавлены настройки сервисов с тестовыми переменными окружения
- **Централизованная система пресетов** — пресет теперь указывается в глобальных настройках через `active_preset`
- **Мердж настроек** — реализовано слияние глобальных настроек с настройками пресета
- **Обновлен logger** — теперь поддерживает новую систему пресетов без зависимости от settings_manager
- **Обновлен env.example** — убрана устаревшая переменная CONFIG_PRESET, добавлен комментарий о настройке пресета
- **Обновлен scenarios_manager** — теперь поддерживает загрузку триггеров и сценариев из пресетов
- **Оптимизация settings_manager** — пресет теперь кэшируется для быстрого доступа
- **Упрощение scenarios_manager** — удалена legacy логика системных триггеров и сценариев
- **Обновлен tg_button_mapper** — теперь поддерживает загрузку кнопок из пресетов
- **Исправлены ссылки на старые пути** — обновлены комментарии и документация
- **Убраны все raise ошибки** — заменены на корректную обработку с логированием

### Fixed
- **Исправлена обработка переменных окружения** — переменные окружения теперь корректно разрешаются во всех утилитах без дублирования логики
- **Улучшена диагностика конфигурации** — `mtproto_manager` теперь предоставляет более информативные сообщения об ошибках и инструкции по настройке

### Breaking Changes
- **Удален файл `mtproto.yaml`** — настройки MTProto теперь находятся в `settings.yaml` под секцией `tg_mtproto`
- **Изменена инициализация переменных окружения** — переменные окружения теперь загружаются автоматически через `settings_manager`, дублирование `load_dotenv()` в отдельных модулях больше не требуется
- **Удален файл `bot.yaml`** — все настройки команд и ролей перенесены в `settings.yaml` под соответствующими секциями
- **Изменен метод `get_bot_config()`** — метод удален из `settings_manager`, настройки теперь получаются через `get_plugin_settings()`

### Documentation
- **Обновлена документация конфигурации** — `SETTINGS_CONFIG_GUIDE.md` обновлен с учетом новой архитектуры конфигурации
- **Добавлены примеры настройки API** — документация дополнена инструкциями по получению и настройке API credentials для MTProto и Telegram Bot
- **Удалена секция `bot.yaml`** — документация обновлена с учетом полного удаления файла из системы конфигурации
- **Обновлена архитектурная документация** — `ARCHITECTURE.md` обновлен с учетом новой структуры конфигурационных файлов
- **Расширена документация настроек** — добавлены детальные описания с примерами для всех настроек сервисов

## [4.0]

*Это релиз с несовместимыми изменениями*
*- изменение возвращаемых значений request_manager с text на response_text*
*- изменение работы action_parser с приоритетом подмены на prev_data (низший) < action_data (средний) < action (высший)*
*- убрана поддержка атрибута console_logging_enabled в settings.yaml используйте настройку по имени console_enabled в сервисе*
*- объединение group_triggers.yaml и triggers.yaml в единый файл triggers.yaml*
*- миграция полей ID в парсерах событий: reply_user_id → reply_entity_id, reply_to_source_id → reply_entity_id, reply_to_type → reply_entity_type*
*- миграция полей ID в парсерах событий: forward_from_user_id → forward_entity_id, forward_from_chat_id → forward_entity_id, forward_from_source_id → forward_entity_id, forward_from_type → forward_entity_type*
*Может потребоваться обновление конфигурации для корректной работы*

## Breaking Changes
- **Миграция полей ID в конфигурациях** — если в ваших сценариях используются старые поля ID, необходимо обновить их на новые:
  - **Reply поля**: `reply_user_id` → `reply_entity_id`, `reply_to_source_id` → `reply_entity_id`, `reply_to_type` → `reply_entity_type`
  - **Forward поля**: `forward_from_user_id` → `forward_entity_id`, `forward_from_chat_id` → `forward_entity_id`, `forward_from_source_id` → `forward_entity_id`, `forward_from_type` → `forward_entity_type`
  - **Плейсхолдеры**: замените `{reply_user_id}` на `{reply_entity_id}` в текстах сообщений и сценариях
  - **Валидаторы**: обновите правила валидации, использующие старые поля ID
  - **Триггеры**: проверьте фильтры и условия, использующие старые поля ID

## Added
- **Универсальная система entity ID в парсерах событий** — полная унификация полей идентификаторов в Bot API и MTProto парсерах:
  - **Новые универсальные поля** — `entity_id` и `entity_type` для основных событий, `reply_entity_id` и `reply_entity_type` для reply сообщений, `forward_entity_id` и `forward_entity_type` для forward сообщений
  - **Упрощение структуры данных** — замена множественных специализированных полей на универсальные пары ID+тип для всех типов entity (пользователи, чаты, каналы)
  - **Консистентность между API** — одинаковые поля в Bot API и MTProto парсерах для упрощения обработки событий
  - **Автоматическая нормализация ID** — корректное преобразование MTProto ID в Bot API формат через `api_utils.normalize_entity_id`
  - **Универсальные методы сравнения** — `api_utils.compare_entity_ids` для корректного сравнения ID любых типов entity
  - **Создание Peer объектов** — `api_utils.create_peer_object` для создания Telethon Peer объектов из Bot API ID
- **Сервис получения истории сообщений (`tg_event_history`)** — полнофункциональный сервис для получения исторических сообщений из Telegram чатов:
  - **Поддержка временных фильтров** — получение сообщений за последние N минут/часов/дней через универсальный атрибут `time_before`
  - **Автоматическое вычисление дат** — `action_parser` автоматически создает `time_before_date` и `time_before_seconds` из строковых значений времени
  - **Корректная обработка часовых поясов** — автоматическое преобразование локального времени в UTC для корректной работы с Telegram API
  - **Универсальный парсер времени** — поддержка форматов "10m", "2h", "1d" и других для удобного указания временных интервалов
  - **Интеграция с MTProto** — использование Telethon для получения истории сообщений с автоматическим подключением
  - **Обработка порядка сообщений** — атрибут `reverse` для контроля порядка обработки (по умолчанию от старых к новым)
  - **Стандартизированные события** — все полученные сообщения преобразуются в стандартный формат событий для совместимости с триггерами
  - **Кэширование и оптимизация** — интеллектуальное управление лимитами запросов и обработкой больших объемов данных
- **Универсальный парсер действий (`action_parser`)** — централизованная утилита для обработки временных атрибутов в действиях:
  - **Автоматическое создание временных атрибутов** — преобразование строковых значений времени в секунды и даты
  - **Поддержка множественных форматов** — обработка `time_before`, `time_after`, (`expire`, `unexpired`, `duration` будут удалены) атрибутов
  - **Умное вычисление дат** — автоматическое создание `*_date` атрибутов на основе времени события с приоритетом явно указанных значений
  - **Интеграция с datetime_formatter** — корректная работа с локальным временем и часовыми поясами
  - **Обратная совместимость** — поддержка старых атрибутов с планом миграции на универсальные `time_before`/`time_after`
- **Исправление обработки часовых поясов в `datetime_formatter`** — критическое исправление логики преобразования времени:
  - **Корректная обработка naive datetime** — naive datetime теперь правильно интерпретируются как локальное время и конвертируются в UTC
  - **Предотвращение двойных конвертаций** — исправлена логика, которая могла приводить к неправильному смещению времени на несколько часов
  - **Универсальная поддержка форматов** — корректная работа с различными форматами дат и времени
- **Универсальный маппинг sender данных для MTProto и Bot API** — реализована единая система извлечения и нормализации данных отправителей:
  - **MTProto события** — использование `event.get_sender()` для получения полных данных отправителя с универсальным маппингом полей для всех типов (User, Chat, Channel)
  - **Bot API события** — универсальный маппинг полей `message.from_user` и `message.chat` для консистентности с MTProto
  - **Нормализация полей** — единообразное извлечение `user_id`, `first_name`, `last_name`, `username`, `is_bot` независимо от источника события
  - **Обработка групп и каналов** — корректное маппирование `title` → `first_name` для групп/каналов, установка `is_bot = False` для не-пользователей
  - **Приоритет sender.id** — всегда использование `sender.id` из `event.get_sender()` для обновления `user_id` в событиях
  - **Обработка reply и forward сообщений** — извлечение всех доступных данных из MTProto событий без дополнительных API запросов
  - **Удаление debug логов** — очистка от диагностических логов после завершения отладки и анализа структур данных
- **Исправление критической ошибки дублирования user_id** — решена проблема с методом `add_or_update` в `UsersRepository`:
  - **Корневая причина** — конфликт между позиционным аргументом `user_id` и ключом `user_id` в `**fields`, что приводило к ошибке "got multiple values for argument 'user_id'"
  - **Архитектурное решение** — рефакторинг метода `add_or_update` для принятия только `**fields` с автоматическим извлечением `user_id` внутри метода
  - **Оптимизация обработки полей** — использование `fields.copy()` и `fields_for_update.pop('user_id', None)` для корректного разделения идентификатора и данных для обновления
  - **Упрощение вызовов** — обновление всех вызовов метода в `tg_message_copy` и `tg_api_utils` для использования нового API
  - **Сохранение функциональности** — полная обратная совместимость с существующей логикой создания и обновления пользователей
- **Оптимизация MTProto логирования** — значительное сокращение избыточных логов для улучшения читаемости:
  - **Централизованная обработка ошибок** — все ошибки MTProto теперь обрабатываются через единый метод `_handle_connection_error`
  - **Фильтрация несущественных ошибок** — автоматическое подавление предупреждений о 'entity', 'peer', 'user', 'chat', 'channel' ошибках
  - **Критические ошибки** — сохранение логирования только для критических проблем (сессии, авторизация, флуд-лимиты)
  - **Удаление debug логов** — очистка от диагностических логов после завершения отладки
- **Диагностика и исправление проблем кэширования файлов** — решена проблема с кэшированием файлов в системе:
  - **Выявление причины предупреждений** — обнаружено, что поля `file_id`, `media_type`, `api_type`, `file_size` корректно сохраняются в JSON поле `hash_metadata`, а предупреждения появляются только при обновлении существующих записей
  - **Подтверждение корректности работы** — система кэширования работает правильно: новые записи создаются с метаданными в JSON, существующие обновляются с игнорированием несуществующих полей модели
  - **Оптимизация логики обновления** — уточнена логика `add_or_update_cache`: при создании новой записи все метаданные сохраняются в `hash_metadata`, при обновлении существующей записи несуществующие поля игнорируются с предупреждением
- **Исправление восстановления bytes объектов из JSON полей** — решена критическая проблема с восстановлением `bytes` объектов (например, `file_reference`) из JSON полей базы данных:
  - **Рекурсивное восстановление** — автоматическое восстановление `bytes` объектов в любых вложенных структурах (dict, list)
  - **Оптимизированная производительность** — ранний выход из рекурсии при отсутствии `bytes:` строк для минимизации накладных расходов
  - **Полная совместимость** — корректная работа с `to_dict()` методом для всех типов данных из базы
  - **Критическая важность** — исправление влияет на все сервисы, использующие MTProto данные (file_manager, tg_message_copy)
- **Поддержка анимированных стикеров (TGS/Lottie)** — полная поддержка анимированных стикеров Telegram:
  - **Корректное определение типа** — автоматическое определение анимированных стикеров по MIME-типу `application/x-tgsticker` и атрибутам `DocumentAttributeAnimated` + `DocumentAttributeSticker`
  - **Правильное расширение файлов** — автоматическое переименование скачанных файлов в `.tgs` формат
  - **Индивидуальная отправка** — анимированные стикеры отправляются отдельно от медиа-групп через `bot.send_sticker`
  - **Интеграция с file_manager** — корректная обработка TGS файлов в системе скачивания и кэширования
- **Оптимизация логики отправки медиа** — улучшенная логика отправки медиа-групп и индивидуальных медиа:
  - **Умное разделение медиа** — автоматическое определение совместимых типов для медиа-групп (фото, видео, документы) и несовместимых для индивидуальной отправки (стикеры, анимированные стикеры, видео-заметки)
  - **Корректная обработка подписей** — правильное прикрепление текста к медиа (для совместимых типов) или отправка отдельным сообщением (для несовместимых)
  - **Универсальная поддержка FSInputFile** — корректное использование `aiogram.types.FSInputFile` для всех типов медиа
  - **Исправление InputDocumentFileLocation** — добавление обязательного параметра `thumb_size` для корректной работы с документами и анимациями
- **ПРОДВИНУТЫЙ RATE LIMITING ДЛЯ MTPROTO — САМАЯ УМНАЯ СИСТЕМА ОГРАНИЧЕНИЙ!** — это не просто rate limiting, это целая экосистема умного управления запросами! Теперь у нас есть:
  - **Множественные семафоры** — отдельные очереди для разных типов операций: entity (3 места), download (1 место), message (1 место), general (2 места). Каждый тип операций имеет свой "пул" для максимальной эффективности!
  - **Динамические адаптивные задержки** — система сама учится и подстраивается! При высокой успешности (>95%) снижает задержки на 20%, при низкой (<80%) увеличивает на 20%. Это как иметь персонального тренера для каждого типа запросов!
  - **Рандомизированные интервалы** — базовая задержка + случайный диапазон для каждого типа операций. Теперь Telegram будет думать что это человек, и ни за что не догадается, что это бот (нет)
  - **Экспоненциальное увеличение при повторах** — каждая неудачная попытка увеличивает задержку на 50%, что предотвращает "атаки" на API при проблемах
  - **Статистика успешности** — система отслеживает успешность каждого типа операций и адаптируется в реальном времени
  - **Контроль конкурентности** — даже если несколько сервисов одновременно вызывают API, они не могут "прорваться" через семафоры и создать спам
  - **Оптимизированные интервалы** — entity: 100-150мс, download: 1.0-1.3 сек, message: 3.0-3.5 сек, general: 1.0-1.5 сек. Никаких лишних ожиданий!
  - **Умная блокировка подключений** — система автоматически блокирует попытки подключения при ошибках: временные ошибки (30-60 сек), флуд-лимиты (по времени от Telegram), постоянные ошибки (навсегда до перезапуска)
  - **Универсальная обработка ошибок** — один метод для всех типов ошибок подключения с умной классификацией и соответствующими таймаутами
  - **Полная безопасность** — теперь MTProto клиент работает как настоящий человек: с паузами, случайными интервалами и адаптивным поведением!
- **entities_parser — САМАЯ ДУШНАЯ УТИЛИТА В ПРОЕКТЕ!** — это была самая душная хрень, которую я делал в жизни! Миллион текстовых сообщений, фиксов, миллиард ошибок, каждый символ уже не на байты, на атомы разбираешь. Сначала разбираешь, а потом собираешь обратно, ваш Человек-Муравей и вся вселенная Marvel отдыхает в сторонке! Информация в инетернете, документация? Да, конечно, иди-ка ты знаешь куда.Telethon не может отдать разметку нормально, получай markdown, да еще и не полный, а ну и еще не рабочий. А как ты это понял? ДА СПУСТЯ БЛИН СОТНЮ СООБЩЕНИЙ ОТЛАДОЧНЫХ! Идешь делать сам. В мире есть десятки библиотек на телеграм, сотни на парсинги и прочую фигню И НИ ОДНОЙ БИБЛИОТЕКИ ПАРСИНГА ЕНТИТИС ОТ ТЕЛЕГРАММА. Может никто не в курсе, что такое вообще существует? Окей, сделал часть entities, радуешься, но недолно, ведь потом опять ловишь очередной баг. Пошел добавлять цитаты — и... Забудь чему тебя учили ранее, ТУТ ВСЕ РАБОТАЕТ НЕ ТАК! Добро пожалорвать в персональный ад. Когда ты уже готов разбить клавиатуру, но все таки починил, оставил на последок текстовые ссылки. Думаешь сейчас все просто будет, куда уж хуже. И спустя час ты уже просто готов выкинуть монитор в окно, потому что телеграму просто ПОФИГУ, что ты там думал, тебе никто и нигде и никак не скажет, а как правильно ЭКРАНИРОВАТЬ ЭКРАНИРОВАТЬ ЭКРАНИРОВАТЬ ЭКРАНИРОВАТЬ... Сначала ты пытаешься понять, потом ищешь любую информацию, ничего не находишь, и в конце ты понимаешь, что проще вспомнить старые добрый БРУТФОРС И ТУПО ПОДОБРАТЬ ПРАВИЛЬНОЕ ЭКРАНИРОВАНИЕ. Да ты просто сначала пытаешься угадать, что нужно получать на выходе, а уже потом осознать. Шучу, осознавать уже не интересует, хочется просто уже забыть это все. И вот в конце это блин работает! РАБОТАЕТ! (но это не точно) У кого еще работает, а? У кого есть еще работающий корректный парсинг от MTProto? То-то же, у меня в проекте теперь есть!
  - **Полная поддержка entities** — все типы (Bold, Italic, Strike, Code, Pre, TextUrl, Url, Mention, Hashtag, BotCommand, Email, Phone, Cashtag, Underline, Blockquote). Да, все. Да именно так. Да вот прямо все (ну ладно не все, кэштегов нет, но уверен, что вы о них даже не слышали)
  - **UTF-16 code units** — разобрался с эмодзи, латиницей, кириллицей, языком древних и т.д., ведь теперь я теперь знаю не по наслышке про UTF-16 и вообще люблю любые степени двойки (а вы знаете сколько символов в слове "ЭКРАНИРОВАТЬ"? Уверены? А `0x042D 0x041A 0x0420 0x0410 0x041D 0x0418 0x0420 0x041E 0x0412 0x0410 0x0422 0x044C` вам о чем-то говорит?)
  - **Умное экранирование** — экранирование символов. Умное. Очень, на столько, что мне так и не удалось выведать их секрет. Может вам повезет больше.
  - **Рабочие ссылки** — `MessageEntityTextUrl` с экранированием URL. Это тот самый рейд-босс. Как только вы думаете, что вы победили, у него будет вторая фаза. Но чтобы вы не расстраивались, вам дадут деревянный меч и третью фазу в подарок.
  - **HTML парсинг — НОВЫЙ АД!** — а вы думали, что с Markdown было плохо? Добро пожаловать в HTML-версию моего личного ада! Теперь у нас есть не только `event_text_markdown`, но и `event_text_html`! Потому что одного формата разметки мало, нужно два! И да, HTML парсинг работает ТОЧНО ТАК ЖЕ КОРРЕКТНО, как и Markdown (то есть никак, но мы делаем вид, что все ок). Теперь можно выбирать между двумя способами сломать себе мозг — Markdown или HTML! А может и оба сразу, для полного счастья?
  - **Производительность** — быстро работает, без лишних зависимостей. Правда не уверен, что быстро, а после таких доработок - не уверен, что и без зависимостей (по крайней мере у меня).
  - **Интеграция с MTProto** — автоматически обрабатывает entities в `event_mtproto` (хотя кажется, что проще было нанять индуса делать это руками)
  - **Уникальность** — пока что это единственное решение, которое реально работает с entities из MTProto! Наверное. Не знаю, не проверял. Можете поискать, я не нашел. Но уникальное! УНИКАЛЬНОЕ! Правда же!?
- **Сервис tg_message_copy — ОТДЕЛЬНЫЙ СЕРВИС КОПИРОВАНИЯ!** — вынесли логику копирования из огромного tg_messenger сервиса в отдельный модульный сервис, потому что tg_messenger уже был размером с небольшой город! Теперь у нас есть:
  - **Модульная архитектура** — разделили на `tg_message_copy.py` (оркестратор), `tg_copy_formatter.py` (форматирование), `tg_copy_utils.py` (MTProto кэш и утилиты), `tg_reply_cache.py` (кэш реплаев), `tg_media_processor.py` (заготовка для медиа)
  - **Кэширование MTProto запросов** — умный кэш для предотвращения спама в MTProto API с FIFO логикой и автоматической очисткой
  - **"Чистые" реплаи** — кэширование скопированных сообщений для создания нативных Telegram реплаев в том же чате
  - **Оптимизированное получение данных пользователей** — приоритетная логика: action → БД → MTProto кэш → MTProto API
  - **Форматирование в стиле Telegram** — "Forwarded from" вместо "Отправлено откуда", "Reply to" с именами пользователей
  - **Поддержка HTML разметки** — сохранение всей разметки при копировании (да, того самого HTML, который мы так долго парсили!)
  - **Универсальная логика форматирования пользователей** — создан универсальный метод `get_formatted_user_name` для обработки всех случаев отображения пользователей (автор, forward, reply) с единой логикой HTML форматирования
  - **Упрощение архитектуры** — удален дублирующий метод `_get_reply_display_name`, вся логика унифицирована через `get_formatted_user_name` и `format_user_display_name`
  - **Обработка случаев без user_id** — корректная обработка случаев когда есть имя пользователя, но нет ID (например, "Mary" в пересланных сообщениях)
  - **Унификация полей forward** — стандартизация полей `forward_from_user_*` между Bot API и MTProto для совместимости
- **MTProto интеграция** — добавлена поддержка Telegram MTProto API (Telethon) для работы с пользовательскими аккаунтами:
  - **Утилита tg_mtproto** — централизованный клиент для работы с MTProto API с поддержкой rate limiting, безопасных API вызовов и автоматического переподключения
  - **Конфигурация MTProto** — новый файл `config/mtproto.yaml` с настройками API credentials, device presets (Windows/Ubuntu) и rate limiting параметрами
  - **Интерактивный инструмент управления** — `tools/mtproto_manager.py` для создания, проверки и диагностики MTProto сессий с диалоговым интерфейсом
  - **Расширение settings_manager** — универсальный метод `resolve_env_variables()` для обработки переменных окружения в формате `${VARIABLE}` в конфигурациях
  - **Поддержка переменных окружения** — автоматическая загрузка API credentials из `MTPROTO_API_ID` и `MTPROTO_API_HASH`
  - **Система управления сессиями** — создание и хранение сессий в `data/sessions/mtproto_session.session` с автоматической авторизацией
- **Сервис event_mtproto** — обработчик событий MTProto API с поддержкой:
  - Фильтрации сообщений от ботов для предотвращения дублирования обработки
  - Обработки медиа-групп через `grouped_id` (аналог `media_group_id` в Bot API)
  - Извлечения вложений (фото, видео, аудио, документы, стикеры, GIF)
  - Поддержки Markdown разметки в `event_text_markdown`
  - Фильтрации чатов через `allowed_chats` в `config/bot.yaml`
  - **Нормализация chat_id** — автоматическое преобразование MTProto ID чатов к Bot API формату для унификации обработки
  - **Отложенная обработка событий** — задержка обработки MTProto событий на 1 секунду для приоритета событий от Bot API
  - **Обработка entities** — автоматическая конвертация entities из Telethon в MarkdownV2 формат для корректного отображения разметки в копируемых сообщениях
- **Система дедупликации событий** — предотвращение повторной обработки одинаковых событий от Bot API и MTProto:
  - Кэш дедупликации в `trigger_manager` с TTL стратегией очистки (15 секунд по умолчанию)
  - Настраиваемые параметры `cache_ttl_seconds` (15) и `cleanup_frequency` (50)
  - Уникальные ключи на основе `chat_id:message_id` для сообщений и `chat_id:callback_id` для коллбеков
  - Singleton режим `trigger_manager` для обеспечения единого кэша между сервисами
- **Утилита tg_media_group_merger** — универсальная утилита для объединения медиа-групп Telegram:
  - Поддержка как `media_group_id` (Bot API), так и `grouped_id` (MTProto)
  - Валидация консистентности данных группы (user_id, chat_id)
  - Объединение вложений и метаданных из всех сообщений группы
- **Расширенная система триггеров** — новая архитектура триггеров с поддержкой:
  - **Множественных сценариев** — возможность указания нескольких сценариев для одного триггера с разными фильтрами
  - **Фильтрации по чатам** — атрибут `from_chat` для ограничения действия триггеров конкретными чатами, типами чатов или всеми чатами
  - **Универсальных обработчиков** — специальный ключ `"*"` для обработки всех сообщений определенного типа
  - **Приоритетов триггеров** — строгий порядок обработки: exact → state → regex → starts_with → contains → "*"
  - **Атрибута continue** — возможность продолжить поиск триггеров после нахождения совпадения
  - **Обратной совместимости** — поддержка старого строкового формата триггеров с автоматическим определением контекста
  - **Атрибута forward_enabled** — контроль обработки пересланных сообщений (по умолчанию игнорируются)
- **Поддержка пересланных сообщений** — расширенная обработка forward сообщений:
  - **Флаги is_forward/is_reply** — добавлены в события для быстрой идентификации типа сообщения
  - **Данные о пересланном сообщении** — извлечение информации об оригинальном отправителе, чате и дате пересылки
  - **Фильтрация по forward_enabled** — триггеры по умолчанию игнорируют пересланные сообщения, требуют явного разрешения
- **Обновление tg_messenger сервиса** — добавлена поддержка возврата `last_message_id` для всех типов отправки сообщений, что позволяет:
  - Получать ID последнего отправленного сообщения для последующего использования
  - Удалять конкретные сообщения по ID через `remove_message_id`
  - Создавать более гибкие цепочки действий с управлением сообщениями
- **Документация по tg_messenger сервису** — добавлены практические примеры работы с отправкой, удалением и управлением сообщениями
- **Расширение tg_messenger сервиса** — добавлен атрибут `exact_message_id` для точного указания сообщения, что позволяет:
  - Подменять `message_id` из `action_data` на конкретное значение
  - Редактировать конкретные сообщения независимо от контекста
  - Создавать reply на конкретные сообщения с точным ID
- **Рефакторинг tg_messenger сервиса** — модульная архитектура с разделением на классы:
  - **`TgMessengerService`** — основной сервис с циклом обработки очереди
  - **`MessageSender`** — класс для отправки и редактирования сообщений
  - **`AttachmentHandler`** — класс для работы с вложениями (парсинг, группировка, отправка)
  - **`MessengerUtils`** — утилиты для определения типов файлов, построения клавиатур
  - Улучшенная архитектура с четким разделением ответственности и правильными публичными API
- **Выделение tg_message_copy сервиса** — вынесли логику копирования из tg_messenger в отдельный сервис для улучшения модульности и упрощения поддержки
- **Рефакторинг file_manager утилиты** — полная переработка архитектуры с модульным подходом:
  - **Модульная структура** — разделение на `core/` (file_downloader, file_validator, file_cache) и `adapters/` (bot_api_adapter, mtproto_adapter)
  - **Универсальное скачивание файлов** — автоматическое определение API (Bot API или MTProto) по формату file_id с поддержкой обоих протоколов
  - **Централизованное кэширование** — интеграция с таблицей `cache` для автоматической очистки скачанных файлов
  - **Упрощенный публичный API** — основной `file_manager.py` стал легкой оберткой с делегированием к специализированным модулям
  - **Расширенные зависимости** — добавлены `tg_mtproto`, `hash_manager`, `database_service`, `bot_initializer` для полной функциональности
  - **Готовность к интеграции** — универсальный метод `download_file()` готов для использования в любых сервисах
- **Рефакторинг `users_directory` → `api_utils`** — расширение функциональности утилиты управления пользователями:
  - **Переименование и расширение** — `users_directory` переименована в `api_utils` с добавлением функций работы с ID чатов
  - **Новые методы для ID чатов** — `get_group_chat_ids()` для нормализации ID групп и `compare_chat_ids()` для сравнения
  - **Унификация обработки ID** — интеграция `api_utils` в сервисы событий для корректной работы с Bot API и MTProto форматами
  - **Удаление дублирования** — убраны локальные методы нормализации в пользу централизованной утилиты
- **Оптимизация file_manager утилиты** — полная переработка архитектуры с универсальными методами:
  - **Универсальный метод get_file_info()** — объединение get_file_extension() и get_content_type() в один эффективный метод с одним вызовом magic.from_file()
  - **Универсальные методы работы с путями** — доработка settings_manager для корректной работы с любыми типами путей (относительные → относительные, абсолютные → абсолютные)
  - **Оптимизированное кэширование** — правильная работа с путями: относительные в БД, абсолютные для использования
  - **Удаление debug логов** — очистка от избыточного логирования для продакшена
  - **Обратная совместимость** — старые методы get_file_extension() и get_content_type() работают через обертки с TODO на удаление
  - **Интеграция с tg_message_copy** — корректная работа скачивания файлов через универсальный file_manager

## Changed
- **Миграция полей ID в парсерах событий** — полная унификация системы идентификаторов entity:
  - **Reply поля** — `reply_user_id` → `reply_entity_id`, `reply_to_source_id` → `reply_entity_id`, `reply_to_type` → `reply_entity_type`
  - **Forward поля** — `forward_from_user_id` → `forward_entity_id`, `forward_from_chat_id` → `forward_entity_id`, `forward_from_source_id` → `forward_entity_id`, `forward_from_type` → `forward_entity_type`
  - **Обновление tg_message_copy сервиса** — использование новых универсальных полей `reply_entity_id`/`reply_entity_type` и `forward_entity_id`/`forward_entity_type`
  - **Обновление конфигураций** — замена `reply_user_id` на `reply_entity_id` в `placeholder_processor/config.yaml` и `restrict.yaml`
  - **Обновление тестов** — миграция всех тестовых данных на новые поля в `test_placeholder_processor.py`
  - **Упрощение парсеров** — удаление дублирующих полей из `tg_mtproto_parser.py` и `tg_bot_parser.py` для упрощения структуры данных
- **Исправление восстановления bytes объектов** — добавлена рекурсивная функция `_restore_bytes_recursive` в `data_converter.py` для корректного восстановления `bytes` объектов из JSON полей базы данных
- **Обновление file_manager для поддержки анимированных стикеров** — добавлен новый тип `animated_sticker` в `file_analyzer.py` с расширением `.tgs` и обновлена логика определения расширений файлов
- **Улучшение event_mtproto для определения анимированных стикеров** — добавлена альтернативная логика определения анимированных стикеров по MIME-типу `application/x-tgsticker` в дополнение к проверке атрибутов
- **Обновление event_manager для поддержки анимированных стикеров** — добавлена поддержка определения анимированных стикеров через `message.sticker.is_animated` в Bot API
- **Оптимизация tg_message_copy для корректной отправки медиа** — обновлена логика `_handle_copy_action` и `_send_individual_media` для поддержки анимированных стикеров и улучшенной обработки медиа-групп
- **Исправление file_downloader для корректной работы с MTProto** — добавлен обязательный параметр `thumb_size` для `InputDocumentFileLocation` и улучшена логика определения расширений файлов
- **Обновление request_manager сервиса** — изменены возвращаемые значения с `text` на `response_text` для консистентности с другими сервисами, что влияет на дальнейшую работу с сервисом и требует обновления сценариев, использующих `{text}` на `{response_text}`
- **Изменение приоритета подмены данных в action_parser** — исправлен порядок мерджа данных: теперь `prev_data` (низший приоритет) < `action_data` (средний приоритет) < основные поля действия (высший приоритет), что обеспечивает корректное переопределение данных в сценариях
- **Рефакторинг media_group_processor** — выделена логика объединения медиа-групп в отдельную утилиту `tg_media_group_merger` для переиспользования между Bot API и MTProto
- **Оптимизация trigger_manager** — добавлен singleton режим для обеспечения единого кэша дедупликации между всеми сервисами событий
- **Улучшение фильтрации событий** — добавлена фильтрация сообщений от ботов в `event_manager` и `event_mtproto` для предотвращения дублирования обработки
- **Объединение конфигурации триггеров** — объединение `group_triggers.yaml` и `triggers.yaml` в единый файл `triggers.yaml` с унифицированной структурой и поддержкой фильтрации по чатам
- **Рефакторинг trigger_processing** — полная переработка логики обработки триггеров с поддержкой множественных сценариев, приоритетов и фильтрации по чатам
- **Обновление scenarios_manager** — удалена поддержка отдельного файла `group_triggers.yaml`, упрощена логика загрузки триггеров
- **Унификация ID чатов** — нормализация MTProto chat_id к Bot API формату для обеспечения совместимости между различными источниками событий
- **Оптимизация file_manager** — универсальные методы работы с путями, оптимизированное кэширование, удаление debug логов
- **Мелкие правки и улучшения плагинов** — исправлены логические ошибки, улучшена структура конфигураций, оптимизирована работа различных компонентов системы