# Версия 3.x

## [3.5] - 2025-09-06

### Added
- **Сервис работы с промокодами (`promo_manager`)** — полнофункциональный сервис для создания, управления и проверки промокодов с поддержкой детерминированной и случайной генерации кодов, гибкой настройки сроков действия, привязки к пользователям, хэш-идентификации и интеграции со сценариями
  - **Расширенная функциональность управления** — упрощенная таблица промокодов, улучшенный детальный вид, расширенная фильтрация по срокам действия, поддержка форматов дат `YYYY-MM-DD` и `YYYY-MM-DD HH:MM:SS`
- **Улучшения `promo_codes` репозитория** — упрощение логики фильтрации, оптимизация производительности, очистка отладочного кода
- **Расширение hash_manager** — методы генерации уникальных кодов с поддержкой длины от 6 до 16 символов и настраиваемыми наборами символов
- **Валидация подписки/участника чата** — правило `is_member` для проверки членства в Telegram чатах/каналах
- **Утилита `users_directory`** — централизованное управление пользователями
- **Глобальное включение плейсхолдеров** — настройка `enable_global_placeholders` в `settings.yaml` для автоматического включения обработки плейсхолдеров во всех действиях без необходимости указывать `placeholder: true` в каждом сценарии
- **PlaceholderProcessor: поддержка точечной нотации** — доступ к вложенным полям объектов через точку с поддержкой всех модификаторов

### Changed
- **Рефакторинг `tg_group_manager`** — интеграция с `users_directory` для унификации работы с пользователями
- **Очистка логов** — удаление избыточных debug логов из core утилит и сервисов

---

## [3.4] - 2025-08-18

### Added
- **Сервис очистки кэша (`cache_cleaner`)** — фоновая очистка таблицы `cache` и связанных файлов с поддержкой:
  - раздельных сроков хранения для записей с файлом и без,
  - пакетной (batch) очистки и VACUUM по порогу,
  - режима `dry_run` для безопасной проверки,
  - разрешения путей к файлам через `settings_manager` и работы через репозиторий `cache`.

### Changed
- **Разделение RequestManager на два сервиса** — выделен отдельный RequestService для обработки запросов пользователей, RequestManager теперь отвечает только за управление запросами (просмотр списка, детали)
- **Оптимизация архитектуры** — улучшена модульность и разделение ответственности между сервисами
- **Конфигурация логгера** — глобальные настройки `config/settings.yaml -> logger.*` теперь приоритетно переопределяют все атрибуты локального плагина (`level`, `file_enabled`, `file_path`, `max_file_size_mb`, `backup_count`, `console_enabled`); сохранена совместимость с ключом `console_logging_enabled`

---

## [3.3] - 2025-08-10

### Added
- **PlaceholderProcessor: поддержка вложенных плейсхолдеров** — добавлена обработка плейсхолдеров внутри параметров модификаторов (fallback, арифметика, format/case, equals/in_list/value) и итеративная подстановка для корректной развёртки многоуровневых конструкций

### Changed
- **Оптимизация таблицы actions** — удалены дублирующие поля `user_id` и `chat_id` (теперь хранятся только в JSON-поле `action_data`)
- **Упрощение структуры БД** — устранение избыточности данных и улучшение консистентности

### Fixed
- **Исправлена работа кэша для работы с речью** — устранены проблемы с некорректным сохранением путей к файлам в метаданных, оптимизирована логика проверки кэша для STT и TTS, предотвращено избыточное скачивание файлов при наличии кэша

---

## [3.2] - 2025-08-08

*Это MAJOR релиз с несовместимыми изменениями - изменение конфигурации settings, требуется обновление settings.yaml для корректной работы*

### Added
- **Сервис обработки речи** — универсальный сервис для работы с речью на базе SaluteSpeech API:
  - **Синтез речи (TTS)** — генерация аудио из текста с поддержкой различных голосов и форматов
  - **Распознавание речи (STT)** — преобразование аудио в текст с гибридным режимом (синхронный/асинхронный)
  - **Поддержка длинных аудио** — обработка аудио через асинхронный API
  - **Система кэширования** — автоматическое кэширование результатов для оптимизации производительности
- **Инструмент обновления сертификатов** — утилита для работы с российскими сертификатами для Сбер API
- **Документация по SSL сертификатам** — подробное руководство по настройке и использованию
- **Система очистки команд** — возможность очистки "зависших" команд для персональных чатов и пользователей через секцию `commands_clear` в `bot.yaml`
- **Глобальное отключение сервисов** — возможность отключать любые сервисы через `settings.yaml` для оптимизации процессов и экономии ресурсов
- **Универсальная утилита хэширования** — `hash_manager` для генерации хэшей из атрибутов и файлов с поддержкой сортировки и быстрого хэширования по метаданным
- **Универсальная система кэширования** — новая таблица `cache` для кэширования любых типов данных с поддержкой файлов и метаданных
- **Универсальная утилита работы с файлами** — `file_manager` для валидации, определения форматов и длительности аудио/видео файлов с поддержкой MIME-типов и оптимизированной производительности

### Changed
- **Глобальная настройка путей к файлам** — централизованное управление базовыми путями для всех вложений через `settings.yaml`
- **Улучшенная инициализация приложения** — добавлена поддержка `settings_manager` для централизованного управления настройками сервисов
- **Оптимизация сервиса обработки речи** — улучшена обработка аудиофайлов, кэширование и совместимость с API SaluteSpeech
- **Расширенные лимиты обработки речи** — синхронный API до 1 минуты, асинхронный API до 10 минут и 100 МБ

### Fixed
- **Исправление дублирования вложений** — устранена проблема добавления всех размеров фото как отдельных вложений, теперь добавляется только самый большой размер
- **Исправление дедупликации событий** — устранена проблема повторной обработки одинаковых событий от Bot API и MTProto через singleton режим trigger_manager
- **Мелкие исправления багов** — улучшение стабильности и надежности системы

### Breaking Changes
- **Изменение конфигурации settings** — добавлена глобальная настройка `file_base_path` в `settings.yaml`, что требует обновления конфигурации для корректной работы сервисов мессенджера

---

## [3.1] - 2025-08-03

### Added
- **Документация по развертыванию** — полное руководство по установке, обновлению и обслуживанию
- **Универсальный скрипт установки** — возможность развернуть проект запуском всего одного скрипта
- **Автоматическое определение корня проекта** — улучшенная логика поиска корневой папки проекта

### Changed
- **Улучшенные скрипты обновления** — переработанная логика обновления с поддержкой всех версий

### Fixed
- **Исправлены баги обновлений** — корректная работа миграции базы данных
- **Исправлены баги в работе сервисов** — улучшена стабильность и надежность компонентов

---

## [3.0] - 2025-08-02

### Added
- **Переработанная система плейсхолдеров** — автоматическое переопределение данных в любом действии
- **Расширенный функционал правил** — новые модификаторы и преобразования для плейсхолдеров
- **Глобальная проверка плейсхолдеров** — возможность включить обработку плейсхолдеров для всех сообщений
- **Оптимизированные алгоритмы** — улучшенная производительность обработки данных
- **Расширенная бизнес-документация** — подробные руководства для пользователей
- **Документация для разработчиков** — технические руководства и API документация
- **Подробный README** — полное описание проекта, возможностей и версий
- **Система версионирования** — подготовка к релизу
- **Универсальный менеджер обновлений** — для быстрого развертывания и установке
- **Расширенная документация по установке** — подробные инструкции для быстрого старта

### Changed
- **Архитектурные улучшения** — доработка и оптимизация ядра системы
- **Улучшенная документация** — структурированная и подробная документация проекта
